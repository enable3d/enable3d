var he=new Map,bt=5,E=(l,e=!1)=>{if(!he.has(l))he.set(l,1);else{let t=he.get(l);if(typeof t>"u"||t>=bt)return;he.set(l,t+1)}e?console.error(`%c [enable3d] ${l} `,"background: #222; color: #bada55"):console.warn(`%c [enable3d] ${l} `,"background: #222; color: #bada55")};var Ye="0.0.7";var _e=class{fn;context;once;constructor(e,t,s=!1){this.fn=e,this.context=t,this.once=s}},Ze=(l,e,t,s,i)=>{if(typeof t!="function")throw new TypeError("The listener must be a function");let n=new _e(t,s||l,i);return l._events.has(e)?l._events.get(e).fn?l._events.set(e,[l._events.get(e),n]):l._events.get(e).push(n):(l._events.set(e,n),l._eventsCount++),l},de=(l,e)=>{--l._eventsCount===0?l._events=new Map:l._events.delete(e)},J=class{static get VERSION(){return Ye}_events=new Map;_eventsCount=0;eventNames(){return Array.from(this._events.keys())}listeners(e){let t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var s=0,i=t.length,n=new Array(i);s<i;s++)n[s]=t[s].fn;return n}listenerCount(e){let t=this._events.get(e);return t?t.fn?1:t.length:0}emit(e,...t){if(!this._events.has(e))return!1;let s=this._events.get(e),i;if(s.fn)return s.once&&this.removeListener(e,s.fn,void 0,!0),s.fn.call(s.context,...t),!0;{let n=s.length;for(i=0;i<n;i++)s[i].once&&this.removeListener(e,s[i].fn,void 0,!0),s[i].fn.call(s[i].context,...t)}return!0}on(e,t,s){return Ze(this,e,t,s,!1)}once(e,t,s){return Ze(this,e,t,s,!0)}removeListener(e,t,s,i){if(!this._events.has(e))return this;if(!t)return de(this,e),this;let n=this._events.get(e);if(n.fn)n.fn===t&&(!i||n.once)&&(!s||n.context===s)&&de(this,e);else{for(var o=0,r=[],a=n.length;o<a;o++)(n[o].fn!==t||i&&!n[o].once||s&&n[o].context!==s)&&r.push(n[o]);r.length?this._events.set(e,r.length===1?r[0]:r):de(this,e)}return this}removeAllListeners(e){return e?this._events.delete(e)&&de(this,e):(this._events=new Map,this._eventsCount=0),this}get off(){return this.removeListener}get addListener(){return this.on}};import{Euler as xt,Quaternion as wt}from"three";var Ee=class{physics;ammo;ptr;body;ignoreScale=!1;isSoftBody=!1;offset={x:0,y:0,z:0};name;errors=[];checkCollisions=!1;impact=[];breakable=!1;fractureImpulse=1;didUpdate=!1;skipUpdate=!1;_emitUpdateEvents=!1;_needUpdate=!1;tmpEuler=new xt;tmpQuaternion=new wt;tmpBtVector3=new Ammo.btVector3;tmpBtVector3_1=new Ammo.btVector3;tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1);eventEmitter=new J;constructor(e,t){this.physics=e,this.ammo=t,this.name=t.name}destructor(){this.eventEmitter&&this.eventEmitter.removeAllListeners(),Ammo.destroy(this.tmpBtVector3),Ammo.destroy(this.tmpBtVector3_1),Ammo.destroy(this.tmpBtQuaternion),Ammo.destroy(this.ammo.getCollisionShape()),Ammo.destroy(this.ammo)}setupEventEmitter(){typeof this.eventEmitter>"u"&&(this.eventEmitter=new J)}get needUpdate(){return this._needUpdate}set needUpdate(e){!e&&this._needUpdate&&(this.didUpdate=!0),this._needUpdate=e}onUpdateEvent(e,t=!1){this.setupEventEmitter(),this._emitUpdateEvents=!0,t?this.eventEmitter.once("update",()=>{e()}):this.eventEmitter.on("update",()=>{e()})}get on(){return{update:e=>this.onUpdateEvent(e),collision:e=>this.onCollision(e)}}get once(){return{update:e=>this.onUpdateEvent(e,!0)}}onCollision(e){this.checkCollisions=!0,this.physics.collisionEvents.on("collision",t=>{let{bodies:s,event:i}=t;s[0].name===this.name?e(s[1],i):s[1].name===this.name&&e(s[0],i)})}transform(){let e=this.physics.worldTransform;this.ammo.getMotionState().getWorldTransform(e)}refresh(){let e=this.physics.worldTransform;this.ammo.getMotionState().setWorldTransform(e)}setRotation(e,t,s){let i=this.tmpEuler.set(e,t,s),n=this.tmpQuaternion.set(0,0,0,1);n.setFromEuler(i),this.tmpBtQuaternion.setValue(0,0,0,1);let o=this.tmpBtQuaternion;o.setValue(n.x,n.y,n.z,n.w),this.physics.worldTransform.setRotation(o)}get rotation(){let e,t,s,n=this.physics.worldTransform.getRotation(),o=this.tmpQuaternion.set(n.x(),n.y(),n.z(),n.w());o.w>1&&(o=o.normalize());let r=2*Math.acos(o.w),a=Math.sqrt(1-o.w*o.w);return a<.001?(e=o.x,t=o.y,s=o.z):(e=o.x/a,t=o.y/a,s=o.z/a),{x:e*r,y:t*r,z:s*r}}get quaternion(){let t=this.physics.worldTransform.getRotation();return{x:t.x(),y:t.y(),z:t.z(),w:t.w()}}setPosition(e,t,s){this.physics.worldTransform.getOrigin().setValue(e,t,s)}get position(){let e=this.physics.worldTransform;return{x:e.getOrigin().x(),y:e.getOrigin().y(),z:e.getOrigin().z()}}get velocity(){return{x:this.ammo.getLinearVelocity().x(),y:this.ammo.getLinearVelocity().y(),z:this.ammo.getLinearVelocity().z()}}get angularVelocity(){return{x:this.ammo.getAngularVelocity().x(),y:this.ammo.getAngularVelocity().y(),z:this.ammo.getAngularVelocity().z()}}setVelocity(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityX(e){this.tmpBtVector3.setValue(e,this.velocity.y,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityY(e){this.tmpBtVector3.setValue(this.velocity.x,e,this.velocity.z),this.ammo.setLinearVelocity(this.tmpBtVector3)}setVelocityZ(e){this.tmpBtVector3.setValue(this.velocity.x,this.velocity.y,e),this.ammo.setLinearVelocity(this.tmpBtVector3)}setAngularVelocity(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityX(e){this.tmpBtVector3.setValue(e,this.angularVelocity.y,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityY(e){this.tmpBtVector3.setValue(this.angularVelocity.x,e,this.angularVelocity.z),this.ammo.setAngularVelocity(this.tmpBtVector3)}setAngularVelocityZ(e){this.tmpBtVector3.setValue(this.angularVelocity.x,this.angularVelocity.y,e),this.ammo.setAngularVelocity(this.tmpBtVector3)}applyForce(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceX(e){this.tmpBtVector3.setValue(e,0,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceY(e){this.tmpBtVector3.setValue(0,e,0),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyForceZ(e){this.tmpBtVector3.setValue(0,0,e),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralForce(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyCentralForce(this.tmpBtVector3)}applyCentralImpulse(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyCentralImpulse(this.tmpBtVector3)}applyCentralLocalForce(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyCentralLocalForce(this.tmpBtVector3)}applyImpulse(e,t){this.tmpBtVector3.setValue(e.x||0,e.y||0,e.z||0),this.tmpBtVector3_1.setValue(t.x||0,t.y||0,t.z||0),this.ammo.applyImpulse(this.tmpBtVector3,this.tmpBtVector3_1)}applyLocalTorque(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyLocalTorque(this.tmpBtVector3)}applyTorque(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyTorque(this.tmpBtVector3)}applyTorqueImpulse(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.applyTorqueImpulse(this.tmpBtVector3)}setCollisionFlags(e){this.ammo.setCollisionFlags(e)}getCollisionFlags(){return this.ammo.getCollisionFlags()}setRestitution(e){this.ammo.setRestitution(e)}setBounciness(e){this.setRestitution(e)}setFriction(e){this.ammo.setFriction(e)}setDamping(e,t){this.ammo.setDamping(e,t)}setGravity(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.setGravity(this.tmpBtVector3)}setLinearFactor(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.setLinearFactor(this.tmpBtVector3)}setAngularFactor(e,t,s){this.tmpBtVector3.setValue(e,t,s),this.ammo.setAngularFactor(this.tmpBtVector3)}setCcdMotionThreshold(e){this.ammo.setCcdMotionThreshold(e)}setCcdSweptSphereRadius(e){this.ammo.setCcdSweptSphereRadius(e)}},je=Ee;import{AnimationMixer as At,LoopOnce as Ct,Object3D as Vt,Vector3 as vt}from"three";var Be=class extends Vt{ptr;isMesh=!1;isExtendedObject3D=!0;isGroup=!1;vector3=new vt;shape;name;body;hasBody=!1;fragmentDepth=0;breakable=!1;fractureImpulse=1;children=[];parent=null;_currentAnimation="";_animationActions=new Map;_animationMixer;constructor(){super(),this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}set animationMixer(e){this._animationMixer=e}get animationMixer(){return this._animationMixer||(this._animationMixer=new At(this)),this._animationMixer}get anims(){return{current:this._currentAnimation,add:(e,t)=>this._animsAdd(e,t),get:e=>this._animsGet(e),play:(e,t=500,s=!0)=>this._animsPlay(e,t,s),mixer:this.animationMixer}}get animation(){return E('Please use "anims" instead of "animation"'),this.anims}_animsAdd(e,t){this._animationActions.set(e,this.animationMixer.clipAction(t))}_animsGet(e){let t=this._animationActions.get(e);return t||E(`Animation(${e}) not found!`),t}_animsPlay(e,t=500,s=!0){let i=this._animationActions.get(e),n=this._animationActions.get(this._currentAnimation);i&&(i.reset(),n&&(i.crossFadeFrom(n,t/1e3,!0),i.clampWhenFinished=!0),s||i.setLoop(Ct,0),i.play()),this._currentAnimation=e}setAction(e){E(`setAction(${e}) is deprecated. Use animation.play(${e}) instead!`)}traverse(e){super.traverse(e)}traverseVisible(e){super.traverseVisible(e)}traverseAncestors(e){super.traverseAncestors(e)}};import{Mesh as Mt,Vector3 as Tt}from"three";var ee=class extends Mt{ptr;isExtendedMesh=!0;isGroup=!1;vector3=new Tt;shape;name;body;hasBody=!1;fragmentDepth=0;breakable=!1;fractureImpulse=1;constructor(e,t){super(e,t),this.name=`object-${this.id}`}get world(){return{theta:this.worldTheta,phi:this.worldPhi}}get worldTheta(){return this.getWorldDirection(this.vector3),Math.atan2(this.vector3.x,this.vector3.z)}get worldPhi(){return this.getWorldDirection(this.vector3),Math.acos(this.vector3.y)}};import{Group as St}from"three";var De=class extends St{ptr;isExtendedGroup=!0;isMesh=!1;shape;name;body;hasBody=!1;fragmentDepth=0;breakable=!1;fractureImpulse=1;constructor(){super(),this.name=`object-${this.id}`}};var Le=class{constructor(e,t){this.factory=e;this.addExisting=t}addPlane(e={},t={}){let s=this.factory.add.plane(e,t);return this.addExisting(s,e),s}addSphere(e={},t={}){let s=this.factory.add.sphere(e,t);return this.addExisting(s,e),s}addBox(e={},t={}){let s=this.factory.add.box(e,t);return this.addExisting(s,e),s}addGround(e,t={}){let s=this.factory.add.ground(e,t),i={...e,mass:0,collisionFlags:1};return this.addExisting(s,i),s}addCapsule(e={},t={}){let s=this.factory.add.capsule(e,t);return this.addExisting(s,e),s}addCylinder(e={},t={}){let s=this.factory.add.cylinder(e,t);return this.addExisting(s,e),s}addCone(e={},t={}){let s=this.factory.add.cone(e,t);return this.addExisting(s,e),s}addTorus(e={},t={}){let s=this.factory.add.torus(e,t);return this.addExisting(s,e),s}addExtrude(e,t={}){let s=this.factory.add.extrude(e,t);return s.translateX(1),this.addExisting(s),s}},Qe=Le;var te=class{constructor(e,t){this.worldTransform=e;this.physicsWorld=t}tmpBtVector3=new Ammo.btVector3;toAmmoV3(e,t=0){return new Ammo.btVector3(typeof e?.x<"u"?e.x:t,typeof e?.y<"u"?e.y:t,typeof e?.z<"u"?e.z:t)}get addConstraints(){return{lock:(e,t,s)=>this.lock(e,t,s),fixed:(e,t,s)=>this.fixed(e,t,s),pointToPoint:(e,t,s,i)=>this.pointToPoint(e,t,s,i),hinge:(e,t,s,i)=>this.hinge(e,t,s,i),slider:(e,t,s={},i)=>this.slider(e,t,s,i),spring:(e,t,s={},i)=>this.spring(e,t,s,i),coneTwist:(e,t,s={frameA:{},frameB:{}},i)=>this.coneTwist(e,t,s,i),dof:(e,t,s,i)=>this.dof(e,t,s,i)}}getTransform(e,t,s={x:0,y:0,z:0},i=!1){s={x:0,y:0,z:0,...s};let n=(r,a)=>{var c=(r.x()-a.x())/2+s.x,h=(r.y()-a.y())/2+s.y,m=(r.z()-a.z())/2+s.z;return new Ammo.btVector3(c,h,m)},o=new Ammo.btTransform;if(o.setIdentity(),i){let r=n(e.getWorldTransform().getOrigin(),t.getWorldTransform().getOrigin()),a=new Ammo.btTransform;a.setIdentity(),a.setOrigin(r);let c=e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform());return c.op_mul(a),{transformA:c,transformB:a}}else return o.setOrigin(new Ammo.btVector3(s.x,s.y,s.z)),{transformA:e.getCenterOfMassTransform().inverse().op_mul(t.getWorldTransform()).op_mul(o),transformB:o}}lock(e,t,s=!0){let i={x:0,y:0,z:0};return this.dof(e,t,{angularLowerLimit:i,angularUpperLimit:i},s)}fixed(e,t,s=!0){let i=this.getTransform(e.ammo,t.ammo);i.transformA.setRotation(e.ammo.getWorldTransform().getRotation()),i.transformB.setRotation(t.ammo.getWorldTransform().getRotation());let n=new Ammo.btFixedConstraint(e.ammo,t.ammo,i.transformA,i.transformB);return this.physicsWorld.addConstraint(n,s),n}pointToPoint(e,t,s={},i=!0){let{pivotA:n,pivotB:o}=s,r=new Ammo.btVector3(n?.x||0,n?.y||0,n?.z||0),a=new Ammo.btVector3(o?.x||0,o?.y||0,o?.z||0),c=new Ammo.btPoint2PointConstraint(e.ammo,t.ammo,r,a);return this.physicsWorld.addConstraint(c,i),c}hinge(e,t,s={},i=!0){let{pivotA:n,pivotB:o,axisA:r,axisB:a}=s,c=new Ammo.btVector3(n?.x||0,n?.y||0,n?.z||0),h=new Ammo.btVector3(o?.x||0,o?.y||0,o?.z||0),m=new Ammo.btVector3(r?.x||0,r?.y||0,r?.z||0),u=new Ammo.btVector3(a?.x||0,a?.y||0,a?.z||0),p=new Ammo.btHingeConstraint(e.ammo,t.ammo,c,h,m,u,!0);return this.physicsWorld.addConstraint(p,i),p}slider(e,t,s={},i=!0){let n=this.getTransform(e.ammo,t.ammo),{frameA:o={},frameB:r={},linearLowerLimit:a=0,linearUpperLimit:c=0,angularLowerLimit:h=0,angularUpperLimit:m=0}=s,u=n.transformA.getRotation();u.setEulerZYX(o.x||0,o.y||0,o.z||0),n.transformA.setRotation(u);let p=n.transformB.getRotation();p.setEulerZYX(r.x||0,r.y||0,r.z||0),n.transformB.setRotation(p);let d=new Ammo.btSliderConstraint(e.ammo,t.ammo,n.transformA,n.transformB,!0);return d.setLowerLinLimit(a),d.setUpperLinLimit(c),d.setLowerAngLimit(h),d.setUpperAngLimit(m),this.physicsWorld.addConstraint(d,i),d}spring(e,t,s={},i=!0){let{stiffness:n=50,damping:o=.01,angularLock:r=!1,linearLowerLimit:a={},linearUpperLimit:c={},angularLowerLimit:h={},angularUpperLimit:m={},offset:u={},center:p=!1,enableSpring:d=!0}=s,f={x:0,y:0,z:0,...u},b=this.getTransform(e.ammo,t.ammo,f,p),y=new Ammo.btGeneric6DofSpringConstraint(e.ammo,t.ammo,b.transformA,b.transformB,!0);this.tmpBtVector3.setValue(a.x||0,a.y||0,a.z||0),y.setLinearLowerLimit(this.tmpBtVector3),this.tmpBtVector3.setValue(c.x||0,c.y||0,c.z||0),y.setLinearUpperLimit(this.tmpBtVector3),r?(this.tmpBtVector3.setValue(0,0,0),y.setAngularLowerLimit(this.tmpBtVector3),y.setAngularUpperLimit(this.tmpBtVector3)):(console.log(h,m),y.setAngularLowerLimit(this.toAmmoV3(h,-Math.PI)),y.setAngularUpperLimit(this.toAmmoV3(m,Math.PI)));for(let M=0;M<3;M++)y.enableSpring(M,d),y.setStiffness(M,n),y.setDamping(M,o);return this.physicsWorld.addConstraint(y,i),y}coneTwist(e,t,s,i=!0){let{frameA:n,frameB:o}=s,r=new Ammo.btTransform;r.setIdentity(),r.getOrigin().setValue(n?.x||0,n?.y||0,n?.z||0);let a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue(o?.x||0,o?.y||0,o?.z||0);let c=this.getTransform(e.ammo,t.ammo),h=new Ammo.btConeTwistConstraint(t.ammo,e.ammo,r,a);return h.setAngularOnly(!0),this.physicsWorld.addConstraint(h,i),h}dof(e,t,s={},i=!0){let{offset:n,center:o=!1}=s,r={x:0,y:0,z:0,...n},a=this.getTransform(e.ammo,t.ammo,r,o),c=new Ammo.btGeneric6DofConstraint(e.ammo,t.ammo,a.transformA,a.transformB,!0),{linearLowerLimit:h,linearUpperLimit:m,angularLowerLimit:u,angularUpperLimit:p}=s,d=this.toAmmoV3(h),f=this.toAmmoV3(m),b=this.toAmmoV3(u,-Math.PI),y=this.toAmmoV3(p,Math.PI);return c.setLinearLowerLimit(d),c.setLinearUpperLimit(f),c.setAngularLowerLimit(b),c.setAngularUpperLimit(y),Ammo.destroy(d),Ammo.destroy(f),Ammo.destroy(b),Ammo.destroy(y),this.physicsWorld.addConstraint(c,i),c}};var $e="0.0.7";var ke=class{fn;context;once;constructor(e,t,s=!1){this.fn=e,this.context=t,this.once=s}},qe=(l,e,t,s,i)=>{if(typeof t!="function")throw new TypeError("The listener must be a function");let n=new ke(t,s||l,i);return l._events.has(e)?l._events.get(e).fn?l._events.set(e,[l._events.get(e),n]):l._events.get(e).push(n):(l._events.set(e,n),l._eventsCount++),l},ue=(l,e)=>{--l._eventsCount===0?l._events=new Map:l._events.delete(e)},G=class{static get VERSION(){return $e}_events=new Map;_eventsCount=0;eventNames(){return Array.from(this._events.keys())}listeners(e){let t=this._events.get(e);if(!t)return[];if(t.fn)return[t.fn];for(var s=0,i=t.length,n=new Array(i);s<i;s++)n[s]=t[s].fn;return n}listenerCount(e){let t=this._events.get(e);return t?t.fn?1:t.length:0}emit(e,...t){if(!this._events.has(e))return!1;let s=this._events.get(e),i;if(s.fn)return s.once&&this.removeListener(e,s.fn,void 0,!0),s.fn.call(s.context,...t),!0;{let n=s.length;for(i=0;i<n;i++)s[i].once&&this.removeListener(e,s[i].fn,void 0,!0),s[i].fn.call(s[i].context,...t)}return!0}on(e,t,s){return qe(this,e,t,s,!1)}once(e,t,s){return qe(this,e,t,s,!0)}removeListener(e,t,s,i){if(!this._events.has(e))return this;if(!t)return ue(this,e),this;let n=this._events.get(e);if(n.fn)n.fn===t&&(!i||n.once)&&(!s||n.context===s)&&ue(this,e);else{for(var o=0,r=[],a=n.length;o<a;o++)(n[o].fn!==t||i&&!n[o].once||s&&n[o].context!==s)&&r.push(n[o]);r.length?this._events.set(e,r.length===1?r[0]:r):ue(this,e)}return this}removeAllListeners(e){return e?this._events.delete(e)&&ue(this,e):(this._events=new Map,this._eventsCount=0),this}get off(){return this.removeListener}get addListener(){return this.on}};import{Box3 as us,BufferGeometry as ps,Euler as fs,Matrix4 as Ue,Quaternion as Me,REVISION as ys,Vector3 as H}from"three";import{Vector3 as L,Matrix4 as W,Box3 as Pt,REVISION as _t}from"three";var se={BOX:"box",CYLINDER:"cylinder",SPHERE:"sphere",CAPSULE:"capsule",CONE:"cone",HULL:"hull",HACD:"hacd",VHACD:"vhacd",MESH:"mesh",HEIGHTFIELD:"heightfield"},ne={ALL:"all",MANUAL:"manual"};var Ke=function(){let l=new L,e=new L,t=new W;return function(s,i,n,o={}){if(o.type=se.HULL,fe(o),o.fit===ne.MANUAL)return console.warn("cannot use fit: manual with type: hull"),null;let r=ze(s,i),a=new Ammo.btVector3,c=new Ammo.btConvexHullShape;c.setMargin(o.margin),e.addVectors(r.max,r.min).multiplyScalar(.5);let h=0;for(let d=0;d<s.length;d++)h+=s[d].length/3;let m=o.hullMaxVertices||1e5;h>m&&console.warn(`too many vertices for hull shape; sampling ~${m} from ~${h} vertices`);let u=Math.min(1,m/h);for(let d=0;d<s.length;d++){let f=s[d];t.fromArray(i[d]);for(let b=0;b<f.length;b+=3){let y=d===s.length-1&&b===f.length-3;(Math.random()<=u||y)&&(l.set(f[b],f[b+1],f[b+2]).applyMatrix4(t).sub(e),a.setValue(l.x,l.y,l.z),c.addPoint(a,y))}}let p=c;if(c.getNumVertices()>=100){let d=new Ammo.btShapeHull(c);d.buildHull(o.margin),Ammo.destroy(c),p=new Ammo.btConvexHullShape(Ammo.getPointer(d.getVertexPointer()),d.numVertices()),Ammo.destroy(d)}return Ammo.destroy(a),ye(p,o,ge(n,o)),p}}(),Je=function(){let l=new L,e=new L,t=new W;return function(s,i,n,o,r={}){if(r.type=se.HACD,fe(r),r.fit===ne.MANUAL)return console.warn("cannot use fit: manual with type: hacd"),[];if(!Ammo.hasOwnProperty("HACD"))return console.warn("HACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];let a=ze(s,i),c=ge(o,r),h=0,m=0;e.addVectors(a.max,a.min).multiplyScalar(.5);for(let g=0;g<s.length;g++)h+=s[g].length/3,n&&n[g]?m+=n[g].length/3:m+=s[g].length/9;let u=new Ammo.HACD;r.hasOwnProperty("compacityWeight")&&u.SetCompacityWeight(r.compacityWeight),r.hasOwnProperty("volumeWeight")&&u.SetVolumeWeight(r.volumeWeight),r.hasOwnProperty("nClusters")&&u.SetNClusters(r.nClusters),r.hasOwnProperty("nVerticesPerCH")&&u.SetNVerticesPerCH(r.nVerticesPerCH),r.hasOwnProperty("concavity")&&u.SetConcavity(r.concavity);let p=Ammo._malloc(h*3*8),d=Ammo._malloc(m*3*4);u.SetPoints(p),u.SetTriangles(d),u.SetNPoints(h),u.SetNTriangles(m);let f=p/8,b=d/4;for(let g=0;g<s.length;g++){let w=s[g];t.fromArray(i[g]);for(let x=0;x<w.length;x+=3)l.set(w[x+0],w[x+1],w[x+2]).applyMatrix4(t).sub(e),Ammo.HEAPF64[f+0]=l.x,Ammo.HEAPF64[f+1]=l.y,Ammo.HEAPF64[f+2]=l.z,f+=3;if(n[g]){let x=n[g];for(let A=0;A<x.length;A++)Ammo.HEAP32[b]=x[A],b++}else for(let x=0;x<w.length/3;x++)Ammo.HEAP32[b]=x,b++}u.Compute(),Ammo._free(p),Ammo._free(d);let y=u.GetNClusters(),M=[];for(let g=0;g<y;g++){let w=new Ammo.btConvexHullShape;w.setMargin(r.margin);let x=u.GetNPointsCH(g),A=u.GetNTrianglesCH(g),v=Ammo._malloc(x*3*8),T=Ammo._malloc(A*3*4);u.GetCH(g,v,T);let P=v/8;for(let C=0;C<x;C++){let V=new Ammo.btVector3,S=Ammo.HEAPF64[P+C*3+0],_=Ammo.HEAPF64[P+C*3+1],R=Ammo.HEAPF64[P+C*3+2];V.setValue(S,_,R),w.addPoint(V,C===x-1),Ammo.destroy(V)}ye(w,r,c),M.push(w)}return M}}(),et=function(){let l=new L,e=new L,t=new W;return function(s,i,n,o,r={}){if(r.type=se.VHACD,fe(r),r.fit===ne.MANUAL)return console.warn("cannot use fit: manual with type: vhacd"),[];if(!Ammo.hasOwnProperty("VHACD"))return console.warn("VHACD unavailable in included build of Ammo.js. Visit https://github.com/mozillareality/ammo.js for the latest version."),[];let a=ze(s,i),c=ge(o,r),h=0,m=0;e.addVectors(a.max,a.min).multiplyScalar(.5);for(let x=0;x<s.length;x++)h+=s[x].length/3,n&&n[x]?m+=n[x].length/3:m+=s[x].length/9;let u=new Ammo.VHACD,p=new Ammo.Parameters;r.hasOwnProperty("resolution")&&p.set_m_resolution(r.resolution),r.hasOwnProperty("depth")&&p.set_m_depth(r.depth),r.hasOwnProperty("concavity")&&p.set_m_concavity(r.concavity),r.hasOwnProperty("planeDownsampling")&&p.set_m_planeDownsampling(r.planeDownsampling),r.hasOwnProperty("convexhullDownsampling")&&p.set_m_convexhullDownsampling(r.convexhullDownsampling),r.hasOwnProperty("alpha")&&p.set_m_alpha(r.alpha),r.hasOwnProperty("beta")&&p.set_m_beta(r.beta),r.hasOwnProperty("gamma")&&p.set_m_gamma(r.gamma),r.hasOwnProperty("pca")&&p.set_m_pca(r.pca),r.hasOwnProperty("mode")&&p.set_m_mode(r.mode),r.hasOwnProperty("maxNumVerticesPerCH")&&p.set_m_maxNumVerticesPerCH(r.maxNumVerticesPerCH),r.hasOwnProperty("minVolumePerCH")&&p.set_m_minVolumePerCH(r.minVolumePerCH),r.hasOwnProperty("convexhullApproximation")&&p.set_m_convexhullApproximation(r.convexhullApproximation),r.hasOwnProperty("oclAcceleration")&&p.set_m_oclAcceleration(r.oclAcceleration);let d=Ammo._malloc(h*3*8+3),f=Ammo._malloc(m*3*4),b=d/8,y=f/4;for(let x=0;x<s.length;x++){let A=s[x];t.fromArray(i[x]);for(let v=0;v<A.length;v+=3)l.set(A[v+0],A[v+1],A[v+2]).applyMatrix4(t).sub(e),Ammo.HEAPF64[b+0]=l.x,Ammo.HEAPF64[b+1]=l.y,Ammo.HEAPF64[b+2]=l.z,b+=3;if(n[x]){let v=n[x];for(let T=0;T<v.length;T++)Ammo.HEAP32[y]=v[T],y++}else for(let v=0;v<A.length/3;v++)Ammo.HEAP32[y]=v,y++}u.Compute(d,3,h,f,3,m,p),Ammo._free(d),Ammo._free(f);let M=u.GetNConvexHulls(),g=[],w=new Ammo.ConvexHull;for(let x=0;x<M;x++){u.GetConvexHull(x,w);let A=w.get_m_nPoints(),v=w.get_m_points(),T=new Ammo.btConvexHullShape;T.setMargin(r.margin);for(let P=0;P<A;P++){let C=new Ammo.btVector3,V=w.get_m_points(P*3+0),S=w.get_m_points(P*3+1),_=w.get_m_points(P*3+2);C.setValue(V,S,_),T.addPoint(C,P===A-1),Ammo.destroy(C)}ye(T,r,c),g.push(T)}return Ammo.destroy(w),Ammo.destroy(u),g}}(),pe=function(){let l=new L,e=new L,t=new L,s=new W;return function(i,n,o,r,a={}){if(a.type=se.MESH,fe(a),a.fit===ne.MANUAL)return console.warn("cannot use fit: manual with type: mesh"),null;let c=ge(r,a),h=new Ammo.btVector3,m=new Ammo.btVector3,u=new Ammo.btVector3,p=new Ammo.btTriangleMesh(!0,!1);for(let b=0;b<i.length;b++){let y=i[b],M=o[b]?o[b]:null;if(s.fromArray(n[b]),M)for(let g=0;g<M.length;g+=3){let w=M[g]*3,x=M[g+1]*3,A=M[g+2]*3;l.set(y[w],y[w+1],y[w+2]).applyMatrix4(s),e.set(y[x],y[x+1],y[x+2]).applyMatrix4(s),t.set(y[A],y[A+1],y[A+2]).applyMatrix4(s),h.setValue(l.x,l.y,l.z),m.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),p.addTriangle(h,m,u,!1)}else for(let g=0;g<y.length;g+=9)l.set(y[g+0],y[g+1],y[g+2]).applyMatrix4(s),e.set(y[g+3],y[g+4],y[g+5]).applyMatrix4(s),t.set(y[g+6],y[g+7],y[g+8]).applyMatrix4(s),h.setValue(l.x,l.y,l.z),m.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z),p.addTriangle(h,m,u,!1)}let d=new Ammo.btVector3(c.x,c.y,c.z);p.setScaling(d),Ammo.destroy(d);let f;return a.concave?f=new Ammo.btBvhTriangleMeshShape(p,!0,!0):f=new Ammo.btConvexTriangleMeshShape(p,!0),f.resources=[p],Ammo.destroy(h),Ammo.destroy(m),Ammo.destroy(u),ye(f,a),f}}();function fe(l){l.type=l.type||se.HULL,l.margin=l.hasOwnProperty("margin")?l.margin:.01}var ye=function(l,e,t){},tt=function(){let l=new W;return function(e,t,s){parseInt(_t)>=123?l.copy(e.matrixWorld).invert():l.getInverse(e.matrixWorld),new L().setFromMatrixScale(e.matrixWorld),e.traverse(n=>{let o=new W;if(n.isMesh&&(t.includeInvisible||n.el&&n.el.object3D.visible||n.visible)){n===e?o.identity():(n.updateWorldMatrix(!0),o.multiplyMatrices(l,n.matrixWorld));let r;if(n.geometry.isBufferGeometry){let a=n.geometry.attributes.position;if(a.isInterleavedBufferAttribute){r=new Float32Array(a.count*a.itemSize);let c=a.offset,h=0;for(;h<r.length;){for(let m=0;m<a.itemSize;m++)r[h++]=a.array[c+m];c+=a.data.stride}}else r=a.array}s(n.geometry.isBufferGeometry?r:n.geometry.vertices,o.elements,n.geometry.index?n.geometry.index.array:null)}})}}(),ge=function(){let l=new W;return function(e,t={}){let s=new L(1,1,1);return t.fit===ne.ALL&&(l.fromArray(e),s.setFromMatrixScale(l)),s}}(),Hs=function(){let l=new L;return function(e,t,s){let i=0,{x:n,y:o,z:r}=s.getCenter(l);return st(e,t,a=>{let c=n-a.x,h=o-a.y,m=r-a.z;i=Math.max(i,c*c+h*h+m*m)}),Math.sqrt(i)}}();var ze=function(l,e){let t=new Pt,s=1/0,i=1/0,n=1/0,o=-1/0,r=-1/0,a=-1/0;return t.min.set(0,0,0),t.max.set(0,0,0),st(l,e,c=>{c.x<s&&(s=c.x),c.y<i&&(i=c.y),c.z<n&&(n=c.z),c.x>o&&(o=c.x),c.y>r&&(r=c.y),c.z>a&&(a=c.z)}),t.min.set(s,i,n),t.max.set(o,r,a),t},st=function(){let l=new L,e=new W;return function(t,s,i){for(let n=0;n<t.length;n++){e.fromArray(s[n]);for(let o=0;o<t[n].length;o+=3)l.set(t[n][o],t[n][o+1],t[n][o+2]).applyMatrix4(e),i(l)}}}();var nt=(l,e)=>{let{radius:t=1,tube:s=.4,tubularSegments:i=8}=l,n=Math.PI,o=i,r=Math.sqrt(2*s*s-2*s*s*Math.cos(2*n/o)),a=new Ammo.btVector3(s,n/o+.5*r,s),c=new Ammo.btCylinderShape(a);c.setMargin(.05);let h=new Ammo.btCompoundShape,m=new Ammo.btVector3(0,0,1),u=new Ammo.btVector3(0,t,0),p=new Ammo.btQuaternion(e.x,e.y,e.z,e.w);for(let d=0;d<o;d++){let f=d*2*n/o,b=u.rotate(m,f),y=new Ammo.btTransform;p.setRotation(m,f+Math.PI/2),y.setIdentity(),y.setOrigin(b),y.setRotation(p),h.addChildShape(y,c)}return h};import{DoubleSide as Bt,Line as Dt,LineBasicMaterial as Lt,MeshBasicMaterial as kt,MeshLambertMaterial as zt,MeshNormalMaterial as Rt,MeshPhongMaterial as Ot,MeshPhysicalMaterial as Ht,MeshStandardMaterial as Ft,MeshToonMaterial as It,Points as Wt,PointsMaterial as Nt,MathUtils as Ut,BoxGeometry as Xt,ExtrudeGeometry as Gt,PlaneGeometry as Yt,SphereGeometry as Zt,CylinderGeometry as jt,ConeGeometry as Qt,TorusGeometry as $t,CapsuleGeometry as qt}from"three";import{MeshLambertMaterial as Et}from"three";var Re=class{_defaultMaterial;constructor(){this._defaultMaterial=new Et({color:13421772})}get(){return this._defaultMaterial}},be=Re;var ie=class{scene;defaultMaterial;isHeadless;constructor(e){this.scene=e,this.isHeadless=e==="headless",this.defaultMaterial=new be}get make(){return{plane:(e={},t={})=>this.makePlane(e,t),box:(e={},t={})=>this.makeBox(e,t),sphere:(e={},t={})=>this.makeSphere(e,t),capsule:(e={},t={})=>this.makeCapsule(e,t),cylinder:(e={},t={})=>this.makeCylinder(e,t),cone:(e={},t={})=>this.makeCone(e,t),torus:(e={},t={})=>this.makeTorus(e,t),extrude:(e,t={})=>this.makeExtrude(e,t)}}get add(){return{mesh:e=>this.addMesh(e),existing:e=>this.addExisting(e),plane:(e={},t={})=>this.addPlane(e,t),box:(e={},t={})=>this.addBox(e,t),ground:(e,t={})=>this.addGround(e,t),sphere:(e={},t={})=>this.addSphere(e,t),capsule:(e={},t={})=>this.addCapsule(e,t),cylinder:(e={},t={})=>this.addCylinder(e,t),cone:(e={},t={})=>this.addCone(e,t),torus:(e={},t={})=>this.addTorus(e,t),extrude:(e,t={})=>this.addExtrude(e,t),material:(e={})=>this.addMaterial(e)}}addExisting(...e){this.scene!=="headless"&&this.scene.add(...e)}addMesh(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.addExisting(e[t]);else this.addExisting(e);return this}createMesh(e,t,s){let{x:i=0,y:n=0,z:o=0}=s,r;switch(!Array.isArray(t)&&t.type){case"LineBasicMaterial":r=new Dt(e,t);break;case"PointsMaterial":r=new Wt(e,t);break;default:r=new ee(e,t);break}return r.position.set(i,n,o),r.castShadow=r.receiveShadow=!0,r}makeExtrude(e,t){let{x:s,y:i,z:n,name:o,shape:r,autoCenter:a=!0,breakable:c=!1,...h}=e,{depth:m=1,bevelEnabled:u=!1}=h,p=new Gt(r,{depth:m,bevelEnabled:u,...h}),d=this.addMaterial(t),f=this.createMesh(p,d,{x:s,y:i,z:n});return a&&f.geometry.center(),f.name=o||`body_id_${f.id}`,f.shape="extrude",f}addExtrude(e,t={}){let s=this.makeExtrude(e,t);return this.addExisting(s),s}makePlane(e,t){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new Yt(a.width||1,a.height||1,a.widthSegments||1,a.heightSegments||1),h=this.addMaterial(t);h.side=Bt;let m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="plane",m}addPlane(e,t){let s=this.makePlane(e,t);return this.addExisting(s),s}makeSphere(e,t){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new Zt(a.radius||1,a.widthSegments||16,a.heightSegments||12,a.phiStart||void 0,a.phiLength||void 0,a.thetaStart||void 0,a.thetaLength||void 0),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="sphere",m}addSphere(e={},t={}){let s=this.makeSphere(e,t);return this.addExisting(s),s}makeBox(e,t){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new Xt(a.width||1,a.height||1,a.depth||1,a.widthSegments||void 0,a.heightSegments||void 0,a.depthSegments||void 0),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="box",m}addBox(e={},t={}){let s=this.makeBox(e,t);return this.addExisting(s),s}addGround(e,t={}){let s=this.makeBox(e,t);return s.rotateX(Ut.degToRad(90)),this.addExisting(s),s}makeCapsule(e={},t={}){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new qt(a.radius||.5,a.length||1,a.capSegments||4,a.radialSegments||16),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="capsule",m}addCapsule(e={},t={}){let s=this.makeCapsule(e,t);return this.addExisting(s),s}makeCylinder(e={},t={}){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new jt(a.radiusTop||1,a.radiusBottom||1,a.height||1,a.radiusSegments||void 0,a.heightSegments||void 0,a.openEnded||void 0,a.thetaStart||void 0,a.thetaLength||void 0),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="cylinder",m}addCylinder(e={},t={}){let s=this.makeCylinder(e,t);return this.addExisting(s),s}makeCone(e={},t={}){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new Qt(a.radius||1,a.height||1,a.radiusSegments||8,a.heightSegments||1,a.openEnded||!1,a.thetaStart||0,a.thetaLength||2*Math.PI),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="cone",m}addCone(e={},t={}){let s=this.makeCone(e,t);return this.addExisting(s),s}makeTorus(e={},t={}){let{x:s,y:i,z:n,name:o,breakable:r=!1,...a}=e,c=new $t(a.radius||void 0,a.tube||void 0,a.radialSegments||void 0,a.tubularSegments||void 0,a.arc||void 0),h=this.addMaterial(t),m=this.createMesh(c,h,{x:s,y:i,z:n});return m.name=o||`body_id_${m.id}`,m.shape="torus",m}addTorus(e={},t={}){let s=this.makeTorus(e,t);return this.addExisting(s),s}addMaterial(e={}){let t=Object.keys(e)[0],s;if(this.scene==="headless")return this.defaultMaterial.get();switch(t){case"basic":s=new kt(e.basic);break;case"normal":s=new Rt(e.normal);break;case"standard":s=new Ft(e.standard);break;case"lambert":s=new zt(e.lambert);break;case"phong":s=new Ot(e.phong);break;case"physical":typeof e.physical<"u"?s=new Ht(e.physical):(E("You need to pass parameters to the physical material. (Fallback to default material)"),s=this.defaultMaterial.get());break;case"toon":s=new It(e.toon);break;case"line":s=new Lt(e.line);break;case"points":s=new Nt(e.points);break;case"custom":s=e.custom||this.defaultMaterial.get();break;default:s=this.defaultMaterial.get();break}return s}};var xe=class extends G{worldTransform;physicsWorld;addCollider(e,t,s){!e.body||!t.body||(e.body.checkCollisions=!0,t.body.checkCollisions=!0,this.on("collision",i=>{let{bodies:n,event:o}=i;n[0]?.name&&n[1]?.name&&e?.name&&t?.name&&(n[0].name===e.name&&n[1].name===t.name||n[1].name===e.name&&n[0].name===t.name)&&s(o)}))}};import{BufferAttribute as it,BufferGeometry as Kt,LineBasicMaterial as Jt,LineSegments as es,StaticDrawUsage as rt}from"three";var ot={NoDebug:0,DrawWireframe:1,DrawAabb:2,DrawFeaturesText:4,DrawContactPoints:8,NoDeactivation:16,NoHelpText:32,DrawText:64,ProfileTimings:128,EnableSatComparison:256,DisableBulletLCP:512,EnableCCD:1024,DrawConstraints:2048,DrawConstraintLimits:4096,FastWireframe:8192,DrawNormals:16384,DrawOnTop:32768,MAX_DEBUG_DRAW_MODE:4294967295},Oe=class{constructor(e,t,s={}){this.scene=e;this.world=t;this.options=s;this.debugDrawMode=s.debugDrawMode||ot.DrawWireframe;let i=this.debugDrawMode&ot.DrawOnTop||!1,n=s.maxBufferSize||1e6;this.geometry=new Kt;let o=new Float32Array(n*3),r=new Float32Array(n*3);this.geometry.setAttribute("position",new it(o,3).setUsage(rt)),this.geometry.setAttribute("color",new it(r,3).setUsage(rt)),this.index=0;let a=new Jt({vertexColors:!0,depthTest:!i});this.mesh=new es(this.geometry,a),i&&(this.mesh.renderOrder=999),this.mesh.frustumCulled=!1,this.enabled=!1,this.debugDrawer=new Ammo.DebugDrawer,this.debugDrawer.drawLine=this.drawLine.bind(this),this.debugDrawer.drawContactPoint=this.drawContactPoint.bind(this),this.debugDrawer.reportErrorWarning=this.reportErrorWarning.bind(this),this.debugDrawer.draw3dText=this.draw3dText.bind(this),this.debugDrawer.setDebugMode=this.setDebugMode.bind(this),this.debugDrawer.getDebugMode=this.getDebugMode.bind(this),this.world.setDebugDrawer(this.debugDrawer)}debugDrawMode;geometry;index;mesh;enabled;debugDrawer;warnedOnce;enable(){this.enabled=!0,this.scene.add(this.mesh)}disable(){this.enabled=!1,this.scene.remove(this.mesh)}update(){this.enabled&&(this.index!=0&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0),this.index=0,this.world.debugDrawWorld(),this.geometry.setDrawRange(0,this.index))}drawLine(e,t,s){let i=Ammo.HEAPF32,n=i[(s+0)/4],o=i[(s+4)/4],r=i[(s+8)/4],a=i[(e+0)/4],c=i[(e+4)/4],h=i[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,a,c,h),this.geometry.attributes.color.setXYZ(this.index++,n,o,r);let m=i[(t+0)/4],u=i[(t+4)/4],p=i[(t+8)/4];this.geometry.attributes.position.setXYZ(this.index,m,u,p),this.geometry.attributes.color.setXYZ(this.index++,n,o,r)}drawContactPoint(e,t,s,i,n){let o=Ammo.HEAPF32,r=o[(n+0)/4],a=o[(n+4)/4],c=o[(n+8)/4],h=o[(e+0)/4],m=o[(e+4)/4],u=o[(e+8)/4];this.geometry.attributes.position.setXYZ(this.index,h,m,u),this.geometry.attributes.color.setXYZ(this.index++,r,a,c);let p=o[(t+0)/4]*s,d=o[(t+4)/4]*s,f=o[(t+8)/4]*s;this.geometry.attributes.position.setXYZ(this.index,h+p,m+d,u+f),this.geometry.attributes.color.setXYZ(this.index++,r,a,c)}reportErrorWarning(e){Ammo.hasOwnProperty("Pointer_stringify")?console.warn(Ammo.Pointer_stringify(e)):this.warnedOnce||(this.warnedOnce=!0,console.warn("Cannot print warningString, please rebuild Ammo.js using 'debug' flag"))}draw3dText(e,t){console.warn("TODO: draw3dText")}setDebugMode(e){this.debugDrawMode=e}getDebugMode(){return this.debugDrawMode}},at=Oe;import{Line3 as as,Mesh as ht,Plane as Ie,Vector3 as B}from"three";import{BufferGeometry as os,Float32BufferAttribute as mt}from"three";import{Line3 as ts,Plane as ss,Triangle as ns,Vector3 as N}from"three";var Ae=0,is=1,rs=new N,lt=new ts,He=new ss,ct=new N,we=new ns,Ce=class{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new Ve,this.unassigned=new Ve,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.vertices.push(new Fe(e[t]));this.compute()}return this}setFromObject(e){let t=[];return e.updateMatrixWorld(!0),e.traverse(function(s){let i=s.geometry;if(i!==void 0){let n=i.attributes.position;if(n!==void 0)for(let o=0,r=n.count;o<r;o++){let a=new N;a.fromBufferAttribute(n,o).applyMatrix4(s.matrixWorld),t.push(a)}}}),this.setFromPoints(t)}containsPoint(e){let t=this.faces;for(let s=0,i=t.length;s<i;s++)if(t[s].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){let s=this.faces,i=-1/0,n=1/0;for(let o=0,r=s.length;o<r;o++){let a=s[o],c=a.distanceToPoint(e.origin),h=a.normal.dot(e.direction);if(c>0&&h>=0)return null;let m=h!==0?-c/h:0;if(!(m<=0)&&(h>0?n=Math.min(m,n):i=Math.max(m,i),i>n))return null}return i!==-1/0?e.at(i,t):e.at(n,t),t}intersectsRay(e){return this.intersectRay(e,rs)!==null}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,t.outside===null?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(e.next!==null&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(e.outside!==null){let t=e.outside,s=e.outside;for(;s.next!==null&&s.next.face===e;)s=s.next;return this.assigned.removeSubList(t,s),t.prev=s.next=null,e.outside=null,t}}deleteFaceVertices(e,t){let s=this.removeAllVerticesFromFace(e);if(s!==void 0)if(t===void 0)this.unassigned.appendChain(s);else{let i=s;do{let n=i.next;t.distanceToPoint(i.point)>this.tolerance?this.addVertexToFace(i,t):this.unassigned.append(i),i=n}while(i!==null)}return this}resolveUnassignedPoints(e){if(this.unassigned.isEmpty()===!1){let t=this.unassigned.first();do{let s=t.next,i=this.tolerance,n=null;for(let o=0;o<e.length;o++){let r=e[o];if(r.mark===Ae){let a=r.distanceToPoint(t.point);if(a>i&&(i=a,n=r),i>1e3*this.tolerance)break}}n!==null&&this.addVertexToFace(t,n),t=s}while(t!==null)}return this}computeExtremes(){let e=new N,t=new N,s=[],i=[];for(let n=0;n<3;n++)s[n]=i[n]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let n=0,o=this.vertices.length;n<o;n++){let r=this.vertices[n],a=r.point;for(let c=0;c<3;c++)a.getComponent(c)<e.getComponent(c)&&(e.setComponent(c,a.getComponent(c)),s[c]=r);for(let c=0;c<3;c++)a.getComponent(c)>t.getComponent(c)&&(t.setComponent(c,a.getComponent(c)),i[c]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:s,max:i}}computeInitialHull(){let e=this.vertices,t=this.computeExtremes(),s=t.min,i=t.max,n=0,o=0;for(let u=0;u<3;u++){let p=i[u].point.getComponent(u)-s[u].point.getComponent(u);p>n&&(n=p,o=u)}let r=s[o],a=i[o],c,h;n=0,lt.set(r.point,a.point);for(let u=0,p=this.vertices.length;u<p;u++){let d=e[u];if(d!==r&&d!==a){lt.closestPointToPoint(d.point,!0,ct);let f=ct.distanceToSquared(d.point);f>n&&(n=f,c=d)}}n=-1,He.setFromCoplanarPoints(r.point,a.point,c.point);for(let u=0,p=this.vertices.length;u<p;u++){let d=e[u];if(d!==r&&d!==a&&d!==c){let f=Math.abs(He.distanceToPoint(d.point));f>n&&(n=f,h=d)}}let m=[];if(He.distanceToPoint(h.point)<0){m.push(k.create(r,a,c),k.create(h,a,r),k.create(h,c,a),k.create(h,r,c));for(let u=0;u<3;u++){let p=(u+1)%3;m[u+1].getEdge(2).setTwin(m[0].getEdge(p)),m[u+1].getEdge(1).setTwin(m[p+1].getEdge(0))}}else{m.push(k.create(r,c,a),k.create(h,r,a),k.create(h,a,c),k.create(h,c,r));for(let u=0;u<3;u++){let p=(u+1)%3;m[u+1].getEdge(2).setTwin(m[0].getEdge((3-u)%3)),m[u+1].getEdge(0).setTwin(m[p+1].getEdge(1))}}for(let u=0;u<4;u++)this.faces.push(m[u]);for(let u=0,p=e.length;u<p;u++){let d=e[u];if(d!==r&&d!==a&&d!==c&&d!==h){n=this.tolerance;let f=null;for(let b=0;b<4;b++){let y=this.faces[b].distanceToPoint(d.point);y>n&&(n=y,f=this.faces[b])}f!==null&&this.addVertexToFace(d,f)}}return this}reindexFaces(){let e=[];for(let t=0;t<this.faces.length;t++){let s=this.faces[t];s.mark===Ae&&e.push(s)}return this.faces=e,this}nextVertexToAdd(){if(this.assigned.isEmpty()===!1){let e,t=0,s=this.assigned.first().face,i=s.outside;do{let n=s.distanceToPoint(i.point);n>t&&(t=n,e=i),i=i.next}while(i!==null&&i.face===s);return e}}computeHorizon(e,t,s,i){this.deleteFaceVertices(s),s.mark=is;let n;t===null?n=t=s.getEdge(0):n=t.next;do{let o=n.twin,r=o.face;r.mark===Ae&&(r.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,o,r,i):i.push(n)),n=n.next}while(n!==t);return this}addAdjoiningFace(e,t){let s=k.create(e,t.tail(),t.head());return this.faces.push(s),s.getEdge(-1).setTwin(t.twin),s.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let s=null,i=null;for(let n=0;n<t.length;n++){let o=t[n],r=this.addAdjoiningFace(e,o);s===null?s=r:r.next.setTwin(i),this.newFaces.push(r.face),i=r}return s.next.setTwin(i),this}addVertexToHull(e){let t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();(e=this.nextVertexToAdd())!==void 0;)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}},k=class l{constructor(){this.normal=new N,this.midpoint=new N,this.area=0,this.constant=0,this.outside=null,this.mark=Ae,this.edge=null}static create(e,t,s){let i=new l,n=new re(e,i),o=new re(t,i),r=new re(s,i);return n.next=r.prev=o,o.next=n.prev=r,r.next=o.prev=n,i.edge=n,i.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){let e=this.edge.tail(),t=this.edge.head(),s=this.edge.next.head();return we.set(e.point,t.point,s.point),we.getNormal(this.normal),we.getMidpoint(this.midpoint),this.area=we.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}},re=class{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){let e=this.head(),t=this.tail();return t!==null?t.point.distanceTo(e.point):-1}lengthSquared(){let e=this.head(),t=this.tail();return t!==null?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}},Fe=class{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}},Ve=class{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,t.prev===null?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,t.next===null?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail;e.next!==null;)e=e.next;return this.tail=e,this}remove(e){return e.prev===null?this.head=e.next:e.prev.next=e.next,e.next===null?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return e.prev===null?this.head=t.next:e.prev.next=t.next,t.next===null?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return this.head===null}};var oe=class extends os{constructor(e=[]){super();let t=[],s=[],n=new Ce().setFromPoints(e).faces;for(let o=0;o<n.length;o++){let r=n[o],a=r.edge;do{let c=a.head().point;t.push(c.x,c.y,c.z),s.push(r.normal.x,r.normal.y,r.normal.z),a=a.next}while(a!==r.edge)}this.setAttribute("position",new mt(t,3)),this.setAttribute("normal",new mt(s,3))}};var dt=l=>{let e=window.THREE&&window.THREE.ConvexGeometry?window.THREE.ConvexGeometry:oe;return new e(l)},z=function(l,e){this.minSizeForBreak=l||1.4,this.smallDelta=e||1e-4,this.tempLine1=new as,this.tempPlane1=new Ie,this.tempPlane2=new Ie,this.tempPlane_Cut=new Ie,this.tempCM1=new B,this.tempCM2=new B,this.tempVector3=new B,this.tempVector3_2=new B,this.tempVector3_3=new B,this.tempVector3_P0=new B,this.tempVector3_P1=new B,this.tempVector3_P2=new B,this.tempVector3_N0=new B,this.tempVector3_N1=new B,this.tempVector3_AB=new B,this.tempVector3_CB=new B,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var t=30*30,s=0;s<t;s++)this.segments[s]=!1};z.prototype={constructor:z,prepareBreakableObject:function(l,e,t,s,i){l.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry."),l.userData.ammoPhysicsData={};var n=l.userData.ammoPhysicsData;n.mass=e,n.velocity=t.clone(),n.angularVelocity=s.clone(),n.breakable=i},subdivideByImpact:function(l,e,t,s,i){var n=[],o=this.tempPlane1,r=this.tempPlane2;this.tempVector3.addVectors(e,t),o.setFromCoplanarPoints(e,l.position,this.tempVector3);var a=i+s,c=this;function h(m,u,p,d){if(Math.random()<d*.05||d>a){n.push(m);return}var f=Math.PI;d===0?(r.normal.copy(o.normal),r.constant=o.constant):d<=s?(f=(p-u)*(.2+.6*Math.random())+u,c.tempVector3_2.copy(l.position).sub(e).applyAxisAngle(t,f).add(e),r.setFromCoplanarPoints(e,c.tempVector3,c.tempVector3_2)):(f=(.5*(d&1)+.2*(2-Math.random()))*Math.PI,c.tempVector3_2.copy(e).sub(m.position).applyAxisAngle(t,f).add(m.position),c.tempVector3_3.copy(t).add(m.position),r.setFromCoplanarPoints(m.position,c.tempVector3_3,c.tempVector3_2)),c.cutByPlane(m,r,c.tempResultObjects);var b=c.tempResultObjects.object1,y=c.tempResultObjects.object2;b&&h(b,u,f,d+1),y&&h(y,f,p,d+1)}return h(l,0,2*Math.PI,0),n},cutByPlane:function(l,e,t){var s=l.geometry,i=s.attributes.position.array,n=s.attributes.normal.array,o=i.length/3,r=o/3,a=s.getIndex();a&&(a=a.array,r=a.length/3);function c(K,gt){var Ge=K*3+gt;return a?a[Ge]:Ge}for(var h=[],m=[],u=this.smallDelta,p=o*o,d=0;d<p;d++)this.segments[d]=!1;for(var f=this.tempVector3_P0,b=this.tempVector3_P1,y=this.tempVector3_N0,M=this.tempVector3_N1,d=0;d<r-1;d++){var g=c(d,0),w=c(d,1),x=c(d,2);y.set(n[g],n[g]+1,n[g]+2);for(var A=d+1;A<r;A++){var v=c(A,0),T=c(A,1),P=c(A,2);M.set(n[v],n[v]+1,n[v]+2);var C=1-y.dot(M)<u;C&&(g===v||g===T||g===P?w===v||w===T||w===P?(this.segments[g*o+w]=!0,this.segments[w*o+g]=!0):(this.segments[x*o+g]=!0,this.segments[g*o+x]=!0):(w===v||w===T||w===P)&&(this.segments[x*o+w]=!0,this.segments[w*o+x]=!0))}}var V=this.tempPlane_Cut;l.updateMatrix(),z.transformPlaneToLocalSpace(e,l.matrix,V);for(var d=0;d<r;d++)for(var S=c(d,0),_=c(d,1),R=c(d,2),O=0;O<3;O++){var D=O===0?S:O===1?_:R,F=O===0?_:O===1?R:S,yt=this.segments[D*o+F];if(!yt){this.segments[D*o+F]=!0,this.segments[F*o+D]=!0,f.set(i[3*D],i[3*D+1],i[3*D+2]),b.set(i[3*F],i[3*F+1],i[3*F+2]);var Y=0,j=V.distanceToPoint(f);j>u?(Y=2,m.push(f.clone())):j<-u?(Y=1,h.push(f.clone())):(Y=3,h.push(f.clone()),m.push(f.clone()));var Z=0,j=V.distanceToPoint(b);if(j>u?(Z=2,m.push(b.clone())):j<-u?(Z=1,h.push(b.clone())):(Z=3,h.push(b.clone()),m.push(b.clone())),Y===1&&Z===2||Y===2&&Z===1){this.tempLine1.start.copy(f),this.tempLine1.end.copy(b);var Q=new B;if(Q=V.intersectLine(this.tempLine1,Q),Q===void 0)return console.error("Internal error: segment does not intersect plane."),t.segmentedObject1=null,t.segmentedObject2=null,0;h.push(Q),m.push(Q.clone())}}}var Xe=l.userData.ammoPhysicsData.mass*.5;this.tempCM1.set(0,0,0);var Te=0,$=h.length;if($>0){for(var d=0;d<$;d++)this.tempCM1.add(h[d]);this.tempCM1.divideScalar($);for(var d=0;d<$;d++){var I=h[d];I.sub(this.tempCM1),Te=Math.max(Te,I.x,I.y,I.z)}this.tempCM1.add(l.position)}this.tempCM2.set(0,0,0);var Se=0,q=m.length;if(q>0){for(var d=0;d<q;d++)this.tempCM2.add(m[d]);this.tempCM2.divideScalar(q);for(var d=0;d<q;d++){var I=m[d];I.sub(this.tempCM2),Se=Math.max(Se,I.x,I.y,I.z)}this.tempCM2.add(l.position)}var U=null,X=null,Pe=0;if($>4)try{U=new ht(dt(h),l.material),U.position.copy(this.tempCM1),U.quaternion.copy(l.quaternion),U.userData=l.userData,this.prepareBreakableObject(U,Xe,l.userData.ammoPhysicsData.velocity,l.userData.ammoPhysicsData.angularVelocity,2*Te>this.minSizeForBreak),Pe++}catch(K){E("Error in ConvexObjectBreaker.ts",!0),E(K,!0)}if(q>4)try{X=new ht(dt(m),l.material),X.position.copy(this.tempCM2),X.quaternion.copy(l.quaternion),X.userData=l.userData,this.prepareBreakableObject(X,Xe,l.userData.ammoPhysicsData.velocity,l.userData.ammoPhysicsData.angularVelocity,2*Se>this.minSizeForBreak),Pe++}catch(K){E("Error in ConvexObjectBreaker.ts",!0),E(K,!0)}return t.object1=U,t.object2=X,Pe}};z.transformFreeVector=function(l,e){var t=l.x,s=l.y,i=l.z,n=e.elements;return l.x=n[0]*t+n[4]*s+n[8]*i,l.y=n[1]*t+n[5]*s+n[9]*i,l.z=n[2]*t+n[6]*s+n[10]*i,l};z.transformFreeVectorInverse=function(l,e){var t=l.x,s=l.y,i=l.z,n=e.elements;return l.x=n[0]*t+n[1]*s+n[2]*i,l.y=n[4]*t+n[5]*s+n[6]*i,l.z=n[8]*t+n[9]*s+n[10]*i,l};z.transformTiedVectorInverse=function(l,e){var t=l.x,s=l.y,i=l.z,n=e.elements;return l.x=n[0]*t+n[1]*s+n[2]*i-n[12],l.y=n[4]*t+n[5]*s+n[6]*i-n[13],l.z=n[8]*t+n[9]*s+n[10]*i-n[14],l};z.transformPlaneToLocalSpace=function(){var l=new B;return function(t,s,i){i.normal.copy(t.normal),i.constant=t.constant;var n=z.transformTiedVectorInverse(t.coplanarPoint(l),s);z.transformFreeVectorInverse(i.normal,s),i.constant=-n.dot(i.normal)}}();var ls=(()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){let l=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(l instanceof WebAssembly.Module)return new WebAssembly.Instance(l)instanceof WebAssembly.Instance}}catch(l){l instanceof Error&&console.error(l.message)}return!1})(),ut=(l,e)=>{var t=document.createElement("script");t.onload=()=>{e()},t.onerror=()=>{throw new Error(`failed to load ${l}`)},t.async=!0,t.src=l,document.head.appendChild(t)},cs=(l,e)=>{ls?ut(`${l}/ammo.wasm.js`,()=>e()):ut(`${l}/ammo.js`,()=>e())},pt=cs;var ms=(l,e)=>{typeof window<"u"&&(window.__loadPhysics=!0),pt(l,()=>{Ammo().then(()=>{e()})})};var hs={};function ds(l,e){e.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(s=>{Object.defineProperty(l.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s)||Object.create(null))})})}var We=ds;var ae=class{constructor(e){this.physics=e}_btRayCallback;getHitPointWorld(){let e=this._btRayCallback.get_m_hitPointWorld();return{x:e.x(),y:e.y(),z:e.z()}}getHitNormalWorld(){let e=this._btRayCallback.get_m_hitNormalWorld();return{x:e.x(),y:e.y(),z:e.z()}}getCollisionObject(){return Ammo.castObject(this._btRayCallback.get_m_collisionObject(),Ammo.btRigidBody).threeObject}};var le=class{constructor(e){this.physics=e}_btRayCallback;getHitPointsWorld(){let e=this._btRayCallback.get_m_hitPointWorld(),t=[];for(let s=e.size()-1;s>=0;s--){let i=e.at(s);t.push({x:i.x(),y:i.y(),z:i.z()})}return t}getHitPointWorld(){return E("Use getHitPointsWorld() instead of getHitPointWorld() for the AllHitsRayCaster!"),this.getHitPointsWorld()}getHitNormalsWorld(){let e=this._btRayCallback.get_m_hitNormalWorld(),t=[];for(let s=e.size()-1;s>=0;s--){let i=e.at(s);t.push({x:i.x(),y:i.y(),z:i.z()})}return t}getCollisionObjects(){let e=[],t=this._btRayCallback.get_m_collisionObjects();for(let s=t.size()-1;s>=0;s--){let i=Ammo.castObject(t.at(s),Ammo.btRigidBody);e.push(i.threeObject)}return e}};var ve=class{constructor(e){this.physics=e}type;_btRayFrom;_btRayTo;_btRayCallback;setRayFromWorld(e=0,t=0,s=0){this._btRayFrom.setValue(e,t,s)}setRayToWorld(e=0,t=0,s=0){this._btRayTo.setValue(e,t,s)}hasHit(){return this._btRayCallback.hasHit()}rayTest(){typeof this._btRayCallback<"u"&&Ammo.destroy(this._btRayCallback),this._btRayCallback=this.type==="closest"?new Ammo.ClosestRayResultCallback(this._btRayFrom,this._btRayTo):new Ammo.AllHitsRayResultCallback(this._btRayFrom,this._btRayTo),this.physics.physicsWorld.rayTest(this._btRayFrom,this._btRayTo,this._btRayCallback)}destroy(){typeof this._btRayFrom<"u"&&Ammo.destroy(this._btRayFrom),typeof this._btRayTo<"u"&&Ammo.destroy(this._btRayTo),typeof this._btRayCallback<"u"&&Ammo.destroy(this._btRayCallback)}},ce=class{constructor(e){this.physics=e}type="closest";_btRayFrom=new Ammo.btVector3(0,0,0);_btRayTo=new Ammo.btVector3(0,0,0);_btRayCallback},me=class{constructor(e){this.physics=e}type="allHits";_btRayFrom=new Ammo.btVector3(0,0,0);_btRayTo=new Ammo.btVector3(0,0,0);_btRayCallback};We(ce,[ve,ae]);We(me,[ve,le]);var Ne=class{autoStart;startTime;oldTime;elapsedTime;running;constructor(e=!0){this.autoStart=e!==void 0?e:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=(typeof performance>"u"?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){let t=(typeof performance>"u"?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}};var ft=class extends G{constructor(t,s={}){super();this.scene=t;this.config=s;this.gravity=s.gravity||{x:0,y:-9.81,z:0},this.isHeadless=t==="headless",this.tmpEuler=new fs,this.tmpQuaternion=new Me,this.tmpVector3=new H,this.tmpVector3a=new H,this.tmpMatrix4=new Ue,this.tmpMatrix4a=new Ue,this.tmpBtVector3=new Ammo.btVector3,this.tmpBtQuaternion=new Ammo.btQuaternion(0,0,0,1),this.emptyV3=new H,this.impactPoint=new H,this.impactNormal=new H,t!=="headless"&&(this.defaultMaterial=new be),this.start()}worldTransform;factory;isHeadless;rigidBodies=[];earlierDetectedCollisions=[];gravity;tmpEuler;tmpQuaternion;tmpVector3;tmpVector3a;tmpMatrix4;tmpMatrix4a;tmpBtVector3;tmpBtQuaternion;physicsWorld;debugDrawer;convexBreaker;addRigidBody;objectsToRemove;numObjectsToRemove;emptyV3;impactPoint;impactNormal;defaultMaterial;shapes;constraints;collisionEvents;complexShapes=["plane","hull","hacd","vhacd","convexMesh","concaveMesh"];get tmpTrans(){return console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform}set tmpTrans(t){console.warn("Use worldTransform instead of tmpTrans."),this.worldTransform=t}destroy(t){let s=Object.keys(t).includes("body")?t.body:t;if(typeof s?.ammo>"u")return;let i=s.ammo.threeObject,n=i.name;if(n&&i&&i?.body?.ammo){i.body.isSoftBody?this.physicsWorld.removeSoftBody(i.body.ammo):this.physicsWorld.removeRigidBody(i.body.ammo),i.body.destructor(),i.body=void 0,i.hasBody=!1,delete s.ammo.threeObject;for(let o=0;o<this.rigidBodies.length;o++)this.rigidBodies[o].name===n&&(this.rigidBodies.splice(o,1),o--)}this.scene==="headless"&&i&&(i=null)}setup(){if(this.worldTransform=new Ammo.btTransform,typeof this.config.setupPhysicsWorld=="function"?this.physicsWorld=this.config.setupPhysicsWorld():this.physicsWorld=this.setupPhysicsWorld(),this.scene!=="headless"){this.convexBreaker=new z,this.objectsToRemove=[],this.numObjectsToRemove=0;for(let t=0;t<500;t++)this.objectsToRemove[t]=null}this.collisionEvents=new xe,this.factory=new ie(this.scene),this.shapes=new Qe(this.factory,(t,s)=>this.addExisting(t,s)),this.constraints=new te(this.worldTransform,this.physicsWorld),this.scene!=="headless"&&(this.debugDrawer=new at(this.scene,this.physicsWorld,{}))}updateDebugger(){this.scene!=="headless"&&this.debugDrawer&&this.debugDrawer.enabled&&this.debugDrawer.update()}setupPhysicsWorld(){let t=this.gravity,{softBodies:s=!1}=this.config,i;if(!s){let n=new Ammo.btDefaultCollisionConfiguration,o=new Ammo.btCollisionDispatcher(n),r=new Ammo.btDbvtBroadphase,a=new Ammo.btSequentialImpulseConstraintSolver;i=new Ammo.btDiscreteDynamicsWorld(o,r,a,n)}if(s){let n=new Ammo.btSoftBodyRigidBodyCollisionConfiguration,o=new Ammo.btCollisionDispatcher(n),r=new Ammo.btDbvtBroadphase,a=new Ammo.btSequentialImpulseConstraintSolver,c=new Ammo.btDefaultSoftBodySolver;i=new Ammo.btSoftRigidDynamicsWorld(o,r,a,n,c)}return i.setGravity(new Ammo.btVector3(t.x,t.y,t.z)),i}createDebrisFromBreakableObject(t,s){this.scene!=="headless"&&(t.material=s.material,t.shape="hull",t.fragmentDepth=s.fragmentDepth+1,t.name=`${s.name}__DEBRIS_${t.id}`,this.scene.add(t),this.addExisting(t,{autoCenter:!0}),t.body.fractureImpulse=s.body.fractureImpulse,t.body.breakable=!1,setTimeout(()=>{t.body.breakable=!0},2500))}removeDebris(t){this.scene!=="headless"&&(this.scene.remove(t),this.destroy(t))}update(t){this.updatePhysics(t),this.detectCollisions()}updatePhysics(t){let s=t/1e3;this.physicsWorld.stepSimulation(s,this.config.maxSubSteps||4,this.config.fixedTimeStep||1/60);for(let i=0;i<this.rigidBodies.length;i++){let n=this.rigidBodies[i];n.body.impact=[];let r=n.body.ammo.getMotionState();if(r){if(r.getWorldTransform(this.worldTransform),n.body.didUpdate&&(n.body._emitUpdateEvents&&n.body.eventEmitter.emit("update"),n.body.didUpdate=!1),n.body.ammo.isKinematicObject()&&n.body.needUpdate)n.getWorldQuaternion(this.tmpQuaternion),n.getWorldPosition(this.tmpVector3),this.tmpBtVector3.setValue(this.tmpVector3.x,this.tmpVector3.y,this.tmpVector3.z),this.tmpBtQuaternion.setValue(this.tmpQuaternion.x,this.tmpQuaternion.y,this.tmpQuaternion.z,this.tmpQuaternion.w),this.worldTransform.setOrigin(this.tmpBtVector3),this.worldTransform.setRotation(this.tmpBtQuaternion),r.setWorldTransform(this.worldTransform),n.body.needUpdate=!1;else if(!n.body.skipUpdate){if(!n.body.ammo.isStaticObject()){let a=this.worldTransform.getOrigin(),c=this.worldTransform.getRotation(),h=n.body.offset;if(n.body.ignoreScale)this.tmpVector3a.set(n.scale.x,n.scale.y,n.scale.z);else{let m=n.body.ammo.getCollisionShape().getLocalScaling();this.tmpVector3a.set(m.x(),m.y(),m.z())}this.tmpVector3.set(a.x()+h.x,a.y()+h.y,a.z()+h.z),this.tmpQuaternion.set(c.x(),c.y(),c.z(),c.w()),this.tmpMatrix4.compose(this.tmpVector3,this.tmpQuaternion,this.tmpVector3a),n.parent?parseInt(ys)>=123?this.tmpMatrix4a.copy(n.parent.matrixWorld).invert():this.tmpMatrix4a.getInverse(n.parent.matrixWorld):this.tmpMatrix4a.identity(),this.tmpMatrix4a.multiply(this.tmpMatrix4),this.tmpMatrix4a.decompose(n.position,n.quaternion,n.scale)}}}}}detectCollisions(){let t=[];this.impactPoint.set(0,0,0),this.impactNormal.set(0,0,0);let s=this.physicsWorld.getDispatcher(),i=s.getNumManifolds();for(let n=0;n<i;n++){let o=s.getManifoldByIndexInternal(n),r=o.getNumContacts(),a=Ammo.castObject(o.getBody0(),Ammo.btRigidBody),c=Ammo.castObject(o.getBody1(),Ammo.btRigidBody),h=a.threeObject,m=c.threeObject;if(!h||!m||a.name===""&&c.name==="")continue;let u=h.body?.checkCollisions,p=m.body?.checkCollisions,d=h.body.breakable,f=m.body.breakable,b=h.body.fractureImpulse,y=m.body.fractureImpulse,M=u||p,g=d||f;if(typeof h.fragmentDepth>"u"&&(h.fragmentDepth=0),typeof m.fragmentDepth>"u"&&(m.fragmentDepth=0),!M&&!g)continue;let w=!1,x=0,A="start";for(let T=0;T<r;T++){let P=o.getContactPoint(T);if(P.getDistance()<=0){w=!0;let V=P.getAppliedImpulse(),S=P.get_m_positionWorldOnB(),_=P.get_m_normalWorldOnB();if(u||p){let R=[h.uuid,m.uuid].sort(),O=`${R[0]}__${R[1]}`;if(this.earlierDetectedCollisions.find(D=>D.combinedName===O)&&(A="collision"),!t.find(D=>D.combinedName===O)){t.push({combinedName:O,collision:!0});let D={x:S.x(),y:S.y(),z:S.z()},F={x:_.x(),y:_.y(),z:_.z()};h.body.impact.push({impulse:V,point:D,normal:F,name:m.name}),m.body.impact.push({impulse:V,point:D,normal:F,name:h.name}),this.collisionEvents.emit("collision",{bodies:[h,m],event:A})}}V>=x&&(x=V,(d||f)&&(this.impactPoint.set(S.x(),S.y(),S.z()),this.impactNormal.set(_.x(),_.y(),_.z())));break}}if(!w||!g)continue;let v=2;if(this.emptyV3.set(0,0,0),h.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:d,physicsBody:a},m.userData.ammoPhysicsData={mass:1,velocity:this.emptyV3,angularVelocity:this.emptyV3,breakable:f,physicsBody:c},d&&x>b&&h.fragmentDepth<v){let T=this.convexBreaker.subdivideByImpact(h,this.impactPoint,this.impactNormal,1,2),P=T.length;for(let C=0;C<P;C++){let V=a.getLinearVelocity(),S=a.getAngularVelocity(),_=T[C];_.userData.ammoPhysicsData.velocity.set(V.x(),V.y(),V.z()),_.userData.ammoPhysicsData.angularVelocity.set(S.x(),S.y(),S.z()),this.createDebrisFromBreakableObject(_,h)}this.objectsToRemove[this.numObjectsToRemove++]=h}if(f&&x>y&&m.fragmentDepth<v){let T=this.convexBreaker.subdivideByImpact(m,this.impactPoint,this.impactNormal,1,2),P=T.length;for(let C=0;C<P;C++){let V=c.getLinearVelocity(),S=c.getAngularVelocity(),_=T[C];_.userData.ammoPhysicsData.velocity.set(V.x(),V.y(),V.z()),_.userData.ammoPhysicsData.angularVelocity.set(S.x(),S.y(),S.z()),this.createDebrisFromBreakableObject(_,m)}this.objectsToRemove[this.numObjectsToRemove++]=m}}for(let n=0;n<this.numObjectsToRemove;n++)this.removeDebris(this.objectsToRemove[n]);this.numObjectsToRemove=0,this.earlierDetectedCollisions.forEach(n=>{let{combinedName:o}=n;if(!t.find(r=>r.combinedName===o)){let r=o.split("__"),a=this.rigidBodies.find(m=>m.uuid===r[0]),c=this.rigidBodies.find(m=>m.uuid===r[1]);a&&c&&this.collisionEvents.emit("collision",{bodies:[a,c],event:"end"})}}),this.earlierDetectedCollisions=[...t]}setGravity(t=0,s=-9.8,i=0){this.tmpBtVector3.setValue(t,s,i),this.physicsWorld.setGravity(this.tmpBtVector3)}get debug(){return this.isHeadless?null:{enable:()=>{this.debugDrawer.enable()},mode:(t=1)=>{this.debugDrawer.setDebugMode(t)},disable:()=>{this.debugDrawer.disable()}}}start(){if(typeof Ammo>"u"){E("Are you sure you included ammo.js?");return}typeof Ammo=="function"?Ammo().then(()=>{this.setup()}):this.setup()}get add(){return{collider:(t,s,i)=>this.collisionEvents.addCollider(t,s,i),constraints:this.constraints.addConstraints,existing:(t,s)=>this.addExisting(t,s),plane:(t={},s={})=>this.shapes.addPlane(t,s),sphere:(t={},s={})=>this.shapes.addSphere(t,s),ground:(t={},s={})=>this.shapes.addGround(t,s),box:(t={},s={})=>this.shapes.addBox(t,s),capsule:(t={},s={})=>this.shapes.addCapsule(t,s),cylinder:(t={},s={})=>this.shapes.addCylinder(t,s),cone:(t={},s={})=>this.shapes.addCone(t,s),torus:(t={},s={})=>this.shapes.addTorus(t,s),extrude:(t,s={})=>this.shapes.addExtrude(t,s),raycaster:(t="closest")=>t==="closest"?new ce(this):new me(this)}}prepareThreeObjectForCollisionShape(t,s={}){let{autoCenter:i=!1}=s,n={width:1,height:1,depth:1,radius:1,radiusTop:1,radiusBottom:1,tube:.4,tubularSegments:6},o="unknown",r=t.isMesh?t.geometry?.type:"unknown";/box/i.test(r)?o="box":/cone/i.test(r)?o="cone":/cylinder/i.test(r)?o="cylinder":/extrude/i.test(r)?o="extrude":/plane/i.test(r)?o="plane":/sphere/i.test(r)?o="sphere":/torus/i.test(r)&&(o="torus");let a={...n,...t?.geometry?.parameters};if(s.shape?(a={...n,...s},o=s.shape):t.shape&&(o=t.shape),Object.keys(a).forEach(c=>{typeof a[c]>"u"&&n[c]&&(a[c]=n[c])}),i){if(t.isMesh&&t.geometry)t.geometry.center();else if(t.isGroup){let c=new us,h=new H;c.setFromObject(t).getCenter(h),t.traverse(m=>{m.isMesh&&m.geometry.translate(-h.x,-h.y,-h.z)})}}return o==="cylinder"&&(a.radius=s.radius||a.radiusTop),o==="extrude"&&(o="hacd"),(o==="mesh"||o==="convex")&&(o="convexMesh"),o==="concave"&&(o="concaveMesh"),o==="unknown"&&(E(`Shape for ${t?.name} not recognized! Will fallback to box.`),o="box"),{shape:o,params:a,object:t}}createCollisionShape(t,s,i){let n=i?.quaternion?i?.quaternion:new Me(0,0,0,1),{axis:o="y"}=s,r=new Ammo.btVector3,a=i?.geometry;i&&a?.isGeometry&&(i.geometry=new ps().fromGeometry(a));let c=f=>{let b=new Ue().elements,y=[],M=[],g=[];return tt(f,{},(w,x,A)=>{y.push(w),M.push(x),g.push(A)}),{vertices:y,matrices:M,indexes:g,matrixWorld:b}},h={};this.complexShapes.indexOf(t)!==-1&&(h=c(i));let m;switch(t){case"box":r.setValue(s.width/2,s.height/2,s.depth/2),m=new Ammo.btBoxShape(r);break;case"sphere":m=new Ammo.btSphereShape(s.radius);break;case"cylinder":switch(o){case"y":r.setValue(s.radius,s.height/2,s.radius),m=new Ammo.btCylinderShape(r);break;case"x":r.setValue(s.height/2,s.radius,s.radius),m=new Ammo.btCylinderShapeX(r);break;case"z":r.setValue(s.radius,s.radius,s.height/2),m=new Ammo.btCylinderShapeZ(r);break}break;case"cone":switch(o){case"y":m=new Ammo.btConeShape(s.radius,s.height);break;case"x":m=new Ammo.btConeShapeX(s.radius,s.height);break;case"z":m=new Ammo.btConeShapeZ(s.radius,s.height);break}break;case"capsule":switch(o){case"y":m=new Ammo.btCapsuleShape(s.radius,s.height);break;case"x":m=new Ammo.btCapsuleShapeX(s.radius,s.height);break;case"z":m=new Ammo.btCapsuleShapeZ(s.radius,s.height);break}break;case"torus":m=nt(s,n);break;case"plane":m=pe(h.vertices,h.matrices,h.indexes,h.matrixWorld,{...s,concave:!1});break;case"hull":m=Ke(h.vertices,h.matrices,h.matrixWorld,s);break;case"hacd":m=Je(h.vertices,h.matrices,h.indexes,h.matrixWorld,s);break;case"vhacd":m=et(h.vertices,h.matrices,h.indexes,h.matrixWorld,s);break;case"convexMesh":m=pe(h.vertices,h.matrices,h.indexes,h.matrixWorld,{...s,concave:!1});break;case"concaveMesh":m=pe(h.vertices,h.matrices,h.indexes,h.matrixWorld,{...s,concave:!0});break}Ammo.destroy(r);let{x:u,y:p,z:d}=s;return(u||p||d)&&(m._compoundOffset={x:u||0,y:p||0,z:d||0}),Array.isArray(m)&&(m=this.mergeCollisionShapesToCompoundShape(m)),m}mergeCollisionShapesToCompoundShape(t){let s=new Ammo.btCompoundShape;return t.forEach(i=>{let{_childOffset:n,_compoundOffset:o}=i;if(n){let{pos:r,quat:a,scale:c,margin:h}=n,m=this.applyPosQuatScaleMargin(i,r,a,c,h);s.addChildShape(m,i)}else if(o){let r=new Ammo.btTransform;r.setIdentity(),r.setOrigin(new Ammo.btVector3(o.x,o.y,o.z)),s.addChildShape(r,i)}else{let r=new Ammo.btTransform;r.setIdentity(),s.addChildShape(r,i)}}),s}addExisting(t,s={}){let{hasBody:i}=t;if(i){E(`Object "${t.name}" already has a physical body!`);return}let n=new H,o=new Me,r=new H;t.getWorldPosition(n),t.getWorldQuaternion(o),t.getWorldScale(r);let a=(s.collisionFlags||0).toString(2).slice(-1)==="1",c=(s.collisionFlags||0).toString(2).slice(-2,-1)==="1",{shape:h="unknown",compound:m=[],mass:u=a||c?0:1,collisionFlags:p=0,collisionGroup:d=1,collisionMask:f=-1,offset:b=void 0,breakable:y=!1,addChildren:M=!0,margin:g=.01,ignoreScale:w=!1,fractureImpulse:x=1}=s;if(w&&r.set(1,1,1),m.length>=1){let C=m.map(R=>this.createCollisionShape(R.shape,R)),V=this.mergeCollisionShapesToCompoundShape(C),S=this.applyPosQuatScaleMargin(V,n,o,r,g),_=this.collisionShapeToRigidBody(V,S,u,c);this.addRigidBodyToWorld(t,_,p,d,f,b),t.body.breakable=y,t.body.fractureImpulse=x,t.body.ignoreScale=w;return}let A=[];if(h!=="unknown"||t.isMesh){let C=this.prepareThreeObjectForCollisionShape(t,s),V=this.createCollisionShape(C.shape,C.params,C.object);A.push(V)}if(h==="unknown"&&M&&t.children.length>=1&&t.children.forEach(C=>{if(C.isMesh){let V=this.prepareThreeObjectForCollisionShape(C),S=this.createCollisionShape(V.shape,V.params,V.object);S._childOffset={pos:C.position.clone(),quat:C.quaternion.clone(),scale:C.scale.clone(),margin:g},A.push(S)}}),A.length===0){let C=this.prepareThreeObjectForCollisionShape(t,s),V=this.createCollisionShape(C.shape,C.params,C.object);A.push(V)}let v=A.length===1?A[0]:this.mergeCollisionShapesToCompoundShape(A),T=this.applyPosQuatScaleMargin(v,n,o,r,g),P=this.collisionShapeToRigidBody(v,T,u,c);this.addRigidBodyToWorld(t,P,p,d,f,b),t.body.breakable=y,t.body.fractureImpulse=x,t.body.ignoreScale=w}addRigidBodyToWorld(t,s,i,n,o,r){this.rigidBodies.push(t),this.physicsWorld.addRigidBody(s,n,o);let a=Object.values(s)[0];t.name||(t.name=`object-${t.id}`),s.name=t.name,t.body=new je(this,s),t.hasBody=!0,t.ptr=a,s.threeObject=t,r&&(t.body.offset={x:0,y:0,z:0,...r}),t.body.setCollisionFlags(i)}applyPosQuatScaleMargin(t,s=new H,i=new Me,n=new H,o=.01){t.setMargin(o);let r=new Ammo.btQuaternion(0,0,0,1);r.setValue(i.x,i.y,i.z,i.w);let a=new Ammo.btTransform;a.setIdentity(),a.getOrigin().setValue(s.x,s.y,s.z),a.setRotation(r),Ammo.destroy(r);let c=new Ammo.btVector3(n.x,n.y,n.z);return t.setLocalScaling(c),Ammo.destroy(c),a}collisionShapeToRigidBody(t,s,i,n){let o=new Ammo.btDefaultMotionState(s),r=new Ammo.btVector3(0,0,0);i>0&&t.calculateLocalInertia(i,r);let a=new Ammo.btRigidBodyConstructionInfo(i,o,t,r),c=new Ammo.btRigidBody(a);return(i>0||n)&&c.setActivationState(4),c}};export{me as AllHitsRaycaster,ft as AmmoPhysics,Ne as Clock,ce as ClosestRaycaster,De as ExtendedGroup,ee as ExtendedMesh,Be as ExtendedObject3D,ms as PhysicsLoader,hs as Types};
/**
 * @author       Yannick Deubel (https://github.com/yandeu)
 * @copyright    Copyright (c) 2020 Yannick Deubel; Project Url: https://github.com/enable3d/enable3d
 * @license      {@link https://github.com/enable3d/enable3d/blob/master/LICENSE|LGPL-3.0}
 */
/**
 * @author       Yannick Deubel (https://github.com/yandeu)
 * @copyright    Copyright (c) 2021 Yannick Deubel; Project Url: https://github.com/enable3d/enable3d
 * @license      {@link https://github.com/enable3d/enable3d/blob/master/LICENSE|LGPL-3.0}
 */
/**
 * @author       Kevin Lee (https://github.com/InfiniteLee)
 * @copyright    Copyright (c) 2020 Kevin Lee; Project Url: https://github.com/InfiniteLee/three-to-ammo
 * @license      {@link https://github.com/InfiniteLee/three-to-ammo/blob/master/LICENSE|MPL-2.0}
 */
/**
 * @author       Kevin Lee (https://github.com/InfiniteLee)
 * @copyright    Copyright (c) 2019 Kevin Lee; Project Url: https://github.com/InfiniteLee/ammo-debug-drawer
 * @license      {@link https://github.com/InfiniteLee/ammo-debug-drawer/blob/master/LICENSE|MPL-2.0}
 */
/*! Bundled license information:

@yandeu/events/lib/index.js:
  (**
   * @package      npmjs.com/package/@yandeu/events (events.min.js)
   *
   * @author       Arnout Kazemier (https://github.com/3rd-Eden)
   * @copyright    Copyright (c) 2014 Arnout Kazemier
   * @license      {@link https://github.com/primus/eventemitter3/blob/master/LICENSE|MIT}
   *
   * @author       Yannick Deubel (https://github.com/yandeu)
   * @copyright    Copyright (c) 2021 Yannick Deubel; Project Url: https://github.com/yandeu/events
   * @license      {@link https://github.com/yandeu/events/blob/master/LICENSE|MIT}
   *)

@yandeu/events/lib/index.js:
  (**
   * @package      npmjs.com/package/@yandeu/events (events.min.js)
   *
   * @author       Arnout Kazemier (https://github.com/3rd-Eden)
   * @copyright    Copyright (c) 2014 Arnout Kazemier
   * @license      {@link https://github.com/primus/eventemitter3/blob/master/LICENSE|MIT}
   *
   * @author       Yannick Deubel (https://github.com/yandeu)
   * @copyright    Copyright (c) 2021 Yannick Deubel; Project Url: https://github.com/yandeu/events
   * @license      {@link https://github.com/yandeu/events/blob/master/LICENSE|MIT}
   *)
*/
